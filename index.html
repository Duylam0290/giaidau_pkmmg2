<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIẢI ĐẤU SOLO POKEMON MEGA 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
        }
        .match {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.25rem;
            width: 200px;
            min-height: 60px;
            padding: 5px;
            margin: 20px 0;
            cursor: pointer;
        }
        .match.admin-enabled:hover {
            border-color: #0ea5e9; /* sky-500 */
        }
        .player {
            padding: 5px;
            display: flex;
            justify-content: space-between;
        }
        .winner {
            font-weight: bold;
            color: #22c55e; /* green-500 */
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin-right: 50px;
        }
        .bracket {
            display: flex;
            overflow-x: auto;
            padding: 20px;
        }
        .connector {
            position: absolute;
            top: 50%;
            left: 100%;
            width: 25px;
            height: 1px;
            background-color: #475569; /* slate-600 */
        }
        .connector-end {
            position: absolute;
            left: 25px;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: #475569; /* slate-600 */
        }
        .match-container {
             position: relative;
        }
        .admin-panel, .login-modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="antialiased font-sans">
    <header class="flex justify-between items-center p-4 border-b border-slate-700">
        <h1 class="text-2xl font-bold tracking-wider text-sky-400">GIẢI ĐẤU SOLO POKEMON MEGA 2</h1>
        <div>
            <button id="login-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded">Admin Login</button>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded hidden">Logout</button>
        </div>
    </header>

    <main id="main-content" class="p-4">
        <div id="message-area" class="text-center text-lg"></div>
        <div id="admin-panel" class="hidden p-4 my-4 bg-slate-800 rounded-lg max-w-lg mx-auto">
            <h2 class="text-xl font-bold mb-4 text-center">Admin Control Panel</h2>
            <div class="mb-4">
                <label for="players" class="block mb-2 text-sm font-medium text-slate-300">Player Names (one per line):</label>
                <textarea id="players" rows="8" class="bg-slate-700 border border-slate-600 text-slate-50 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5" placeholder="Player 1&#10;Player 2&#10;Player 3..."></textarea>
            </div>
            <div class="mb-4">
                <label for="tournament-size" class="block mb-2 text-sm font-medium text-slate-300">Tournament Size:</label>
                <select id="tournament-size" class="bg-slate-700 border border-slate-600 text-slate-50 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5">
                    <option value="4">4 Players</option>
                    <option value="8">8 Players</option>
                    <option value="16">16 Players</option>
                </select>
            </div>
            <button id="create-tournament-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Create Tournament</button>
        </div>
        <div id="bracket" class="bracket"></div>
    </main>
    
    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center login-modal-backdrop">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Admin Login</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block mb-2 text-sm font-medium text-slate-300">Password:</label>
                    <input type="password" id="password" class="bg-slate-700 border border-slate-600 text-slate-50 text-sm rounded-lg block w-full p-2.5" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 h-4"></p>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-login-btn" class="py-2 px-4 rounded bg-slate-600 hover:bg-slate-700">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded bg-sky-500 hover:bg-sky-600">Login</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyB7ku0_Lv002jd0F_apjp5JoujuItRiPF0VfsxOpfBlU6uLYgrNMOCM8BizTwEyt5/exec';

        const bracketContainer = document.getElementById('bracket');
        const messageArea = document.getElementById('message-area');
        const adminPanel = document.getElementById('admin-panel');
        const createTournamentBtn = document.getElementById('create-tournament-btn');
        const playersTextarea = document.getElementById('players');
        const tournamentSizeSelect = document.getElementById('tournament-size');
        
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const loginError = document.getElementById('login-error');

        function showMessage(text, isError = false) {
            messageArea.textContent = text;
            messageArea.className = isError ? 'text-center text-lg text-red-500' : 'text-center text-lg text-slate-400';
        }

        function updateAdminUI(isLoggedIn) {
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                adminPanel.classList.add('hidden');
            }
            fetchTournamentData(); // Re-render bracket to apply/remove admin classes
        }
        
        async function fetchTournamentData() {
            if (!SCRIPT_URL || SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbyyB7ku0_Lv002jd0F_apjp5JoujuItRiPF0VfsxOpfBlU6uLYgrNMOCM8BizTwEyt5/exec') {
                showMessage('Chưa có thông tin giải đấu', true);
                return;
            }
            showMessage('Loading tournament data...');
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderBracket(data);
                messageArea.textContent = '';
            } catch (error) {
                console.error('Error fetching data:', error);
                showMessage('Could not load tournament data. Is the script URL correct and deployed?', true);
            }
        }

        function renderBracket(data) {
            bracketContainer.innerHTML = '';
            if (!data || data.length === 0) {
                showMessage('No tournament data found. Create one from the admin panel.');
                return;
            }

            const rounds = {};
            data.forEach(match => {
                if (!rounds[match.Round]) {
                    rounds[match.Round] = [];
                }
                rounds[match.Round].push(match);
            });

            const isLoggedIn = sessionStorage.getItem('isAdmin') === 'true';

            Object.keys(rounds).sort((a,b) => a-b).forEach(roundNum => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round';
                roundDiv.dataset.round = roundNum;

                rounds[roundNum].sort((a,b) => a.Match - b.Match).forEach(matchData => {
                    const matchContainer = document.createElement('div');
                    matchContainer.className = 'match-container';
                    
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match';
                    if (isLoggedIn) {
                        matchDiv.classList.add('admin-enabled');
                    }
                    matchDiv.dataset.round = matchData.Round;
                    matchDiv.dataset.match = matchData.Match;

                    const player1Div = createPlayerDiv(matchData.Player1, matchData.Winner);
                    const player2Div = createPlayerDiv(matchData.Player2, matchData.Winner);
                    
                    matchDiv.appendChild(player1Div);
                    matchDiv.appendChild(player2Div);

                    // Add connectors
                    const nextRoundExists = rounds[parseInt(roundNum) + 1];
                    if (nextRoundExists) {
                        const connector = document.createElement('div');
                        connector.className = 'connector';
                        const connectorEnd = document.createElement('div');
                        connectorEnd.className = 'connector-end';
                        connector.appendChild(connectorEnd);
                        matchContainer.appendChild(connector);
                    }
                    
                    matchContainer.prepend(matchDiv);
                    roundDiv.appendChild(matchContainer);
                });
                bracketContainer.appendChild(roundDiv);
            });
        }
        
        function createPlayerDiv(playerName, winner) {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player';
            playerDiv.textContent = playerName || 'TBD';
            if (playerName && playerName === winner) {
                playerDiv.classList.add('winner');
            }
            return playerDiv;
        }

        async function updateMatch(round, match, winner) {
            showMessage('Updating match result...');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateMatch', round, match, winner })
                });
                const result = await response.json();
                if (result.success) {
                    fetchTournamentData();
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error updating match:', error);
                showMessage(`Failed to update match: ${error.message}`, true);
            }
        }

        bracketContainer.addEventListener('click', (e) => {
            if (sessionStorage.getItem('isAdmin') !== 'true') return;
            
            const matchEl = e.target.closest('.match');
            if (!matchEl) return;
            
            const { round, match } = matchEl.dataset;
            const player1 = matchEl.children[0].textContent;
            const player2 = matchEl.children[1].textContent;

            if (player1 === 'TBD' || player2 === 'TBD' || !player1 || !player2) return;

            const winner = prompt(`Select winner for Round ${round}, Match ${match}:\n1. ${player1}\n2. ${player2}`, '1');
            if (winner === '1') {
                updateMatch(round, match, player1);
            } else if (winner === '2') {
                updateMatch(round, match, player2);
            }
        });

        createTournamentBtn.addEventListener('click', async () => {
            const players = playersTextarea.value.split('\n').filter(p => p.trim() !== '');
            const size = parseInt(tournamentSizeSelect.value);

            if (players.length > size) {
                alert(`You have ${players.length} players, but the tournament size is ${size}. Please remove some players or increase the tournament size.`);
                return;
            }
            
            if (players.length < 2) {
                alert('Please enter at least 2 players.');
                return;
            }

            if (!confirm(`This will delete any existing tournament data. Are you sure you want to create a new ${size}-player tournament?`)) {
                return;
            }
            
            showMessage('Creating new tournament...');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'createTournament', players, size })
                });
                const result = await response.json();
                if (result.success) {
                    playersTextarea.value = '';
                    fetchTournamentData();
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error creating tournament:', error);
                showMessage(`Failed to create tournament: ${error.message}`, true);
            }
        });
        
        loginBtn.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
            passwordInput.focus();
            loginError.textContent = '';
        });
        
        cancelLoginBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            loginError.textContent = '';
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', password })
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                
                const textResponse = await response.text();
                try {
                    const result = JSON.parse(textResponse);
                    if (result.success) {
                        sessionStorage.setItem('isAdmin', 'true');
                        updateAdminUI(true);
                        loginModal.classList.add('hidden');
                        passwordInput.value = '';
                    } else {
                        throw new Error(result.message || 'Incorrect password');
                    }
                } catch (jsonError) {
                    console.error("Failed to parse JSON:", textResponse);
                    throw new Error("Response is not JSON. Check Apps Script permissions. 'Who has access' must be 'Anyone'.");
                }

            } catch (error) {
                console.error('Login failed:', error);
                loginError.textContent = error.message;
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('isAdmin');
            updateAdminUI(false);
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isAdmin') === 'true') {
                updateAdminUI(true);
            } else {
                fetchTournamentData();
            }
        });
    </script>
</body>
</html>
